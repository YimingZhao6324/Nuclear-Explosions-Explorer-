{
   "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
   "title":{
      "text":"Nuclear Explosions Explorer",
      "anchor":"middle",
      "fontSize":30,
      "offset":30
   },
   "params":[
      {
         "name":"Latitude",
         "value":0,
         "bind":{
            "input":"range",
            "min":-90,
            "max":90,
            "step":1
         }
      },
      {
         "name":"Longitude",
         "value":0,
         "bind":{
            "input":"range",
            "min":-90,
            "max":90,
            "step":1
         }
      }
   ],
   "data":{
      "url":"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-08-20/nuclear_explosions.csv"
   },
   "vconcat":[
      {
         "hconcat":[
            {
               "vconcat":[
                  {
                     "transform":[
                        {
                           "filter":{
                              "param":"year_brush"
                           }
                        },
                        {
                           "filter":{
                              "param":"country_select"
                           }
                        },
                        {
                           "filter":{
                              "param":"type_select"
                           }
                        }
                     ],
                     "width":200,
                     "height":150,
                     "encoding":{
                        "y":{
                           "field":"country",
                           "type":"nominal",
                           "title":"Country",
                           "sort":{
                              "op":"count",
                              "order":"descending"
                           }
                        },
                        "x":{
                           "aggregate":"count",
                           "type":"quantitative"
                        },
                        "color":{
                           "field":"country"
                        }
                     },
                     "layer":[
                        {
                           "mark":"bar"
                        },
                        {
                           "mark":{
                              "type":"text",
                              "align":"left",
                              "baseline":"middle",
                              "dx":3
                           },
                           "encoding":{
                              "text":{
                                 "aggregate":"count",
                                 "type":"quantitative"
                              }
                           }
                        }
                     ]
                  },
                  {
                     "params":[
                        {
                           "name":"region_select",
                           "select":{
                              "type":"point",
                              "fields":[
                                 "region"
                              ]
                           }
                        }
                     ],
                     "transform":[
                        {
                           "filter":{
                              "param":"year_brush"
                           }
                        },
                        {
                           "filter":{
                              "param":"country_select"
                           }
                        },
                        {
                           "joinaggregate":[
                              {
                                 "op":"count",
                                 "field":"region",
                                 "as":"TheSum"
                              }
                           ],
                           "groupby":[
                              "region"
                           ]
                        },
                        {
                           "window":[
                              {
                                 "op":"dense_rank",
                                 "as":"rank"
                              }
                           ],
                           "sort":[
                              {
                                 "field":"TheSum",
                                 "order":"descending"
                              }
                           ]
                        },
                        {
                           "filter":"datum.rank <= 5"
                        },
                        {
                           "filter":{
                              "param":"type_select"
                           }
                        }
                     ],
                     "width":200,
                     "height":150,
                     "mark":"bar",
                     "encoding":{
                        "y":{
                           "field":"region",
                           "title":"Region",
                           "type":"nominal",
                           "sort":{
                              "op":"count",
                              "order":"descending"
                           }
                        },
                        "x":{
                           "aggregate":"count",
                           "type":"quantitative",
                           "axis":{
                              "title":"Count of Records (Top 5)"
                           }
                        },
                        "color":{
                           "condition":{
                              "param":"region_select",
                              "field":"country"
                           },
                           "value":"gray"
                        }
                     }
                  }
               ]
            },
            {
               "transform":[
                  {
                     "filter":{
                        "param":"year_brush"
                     }
                  },
                  {
                     "filter":{
                        "param":"type_select"
                     }
                  },
                  {
                     "filter":{
                        "param":"region_select"
                     }
                  },
                  {
                     "calculate":"'https://www.google.com/search?q=' + datum.name + ' nuclear explosion'",
                     "as":"url"
                  }
               ],
               "width":400,
               "height":380,
               "projection":{
                  "type":"orthographic",
                  "rotate":{
                     "expr":"[Latitude, Longitude, 0]"
                  }
               },
               "layer":[
                  {
                     "data":{
                        "sphere":true
                     },
                     "mark":{
                        "type":"geoshape",
                        "fill":"lightskyblue"
                     }
                  },
                  {
                     "data":{
                        "name":"world",
                        "url":"data/world-110m.json",
                        "format":{
                           "type":"topojson",
                           "feature":"countries"
                        }
                     },
                     "mark":{
                        "type":"geoshape",
                        "fill":"lemonchiffon",
                        "stroke":"black"
                     }
                  },
                  {
                     "params":[
                        {
                           "name":"country_select",
                           "select":{
                              "type":"point",
                              "fields":[
                                 "country"
                              ]
                           },
                           "bind":"legend"
                        }
                     ],
                     "transform":[
                        {
                           "filter":"(Latitude * -1) - 90 < datum.longitude && datum.longitude < (Latitude * -1) + 90 && (Longitude * -1) - 90 < datum.latitude && datum.latitude < (Longitude * -1) + 90"
                        }
                     ],
                     "mark":{
                        "type":"circle",
                        "tooltip":{
                           "content":"data"
                        }
                     },
                     "encoding":{
                        "longitude":{
                           "field":"longitude",
                           "type":"quantitative"
                        },
                        "latitude":{
                           "field":"latitude",
                           "type":"quantitative"
                        },
                        "color":{
                           "field":"country"
                        },
                        "opacity":{
                           "condition":{
                              "param":"country_select",
                              "value":1
                           },
                           "value":0
                        },
                        "href":{
                           "field":"url",
                           "type":"nominal"
                        }
                     }
                  }
               ]
            },
            {
               "vconcat":[
                  {
                     "params":[
                        {
                           "name":"type_select",
                           "select":{
                              "type":"point",
                              "fields":[
                                 "type"
                              ]
                           }
                        }
                     ],
                     "transform":[
                        {
                           "filter":{
                              "param":"year_brush"
                           }
                        },
                        {
                           "filter":{
                              "param":"country_select"
                           }
                        },
                        {
                           "joinaggregate":[
                              {
                                 "op":"count",
                                 "field":"type",
                                 "as":"TheSumofType"
                              }
                           ],
                           "groupby":[
                              "type"
                           ]
                        },
                        {
                           "window":[
                              {
                                 "op":"dense_rank",
                                 "as":"rank"
                              }
                           ],
                           "sort":[
                              {
                                 "field":"TheSumofType",
                                 "order":"descending"
                              }
                           ]
                        },
                        {
                           "filter":"datum.rank <= 5"
                        },
                        {
                           "filter":{
                              "param":"region_select"
                           }
                        }
                     ],
                     "width":200,
                     "height":150,
                     "mark":"bar",
                     "encoding":{
                        "y":{
                           "field":"type",
                           "title":"Type",
                           "type":"nominal",
                           "sort":{
                              "op":"count",
                              "order":"descending"
                           }
                        },
                        "x":{
                           "aggregate":"count",
                           "type":"quantitative",
                           "axis":{
                              "title":"Count of Records (Top 5)"
                           }
                        },
                        "color":{
                           "condition":{
                              "param":"type_select",
                              "field":"country"
                           },
                           "value":"gray"
                        }
                     }
                  },
                  {
                     "width":200,
                     "height":150,
                     "layer":[
                        {
                           "transform":[
                              {
                                 "filter":{
                                    "param":"year_brush"
                                 }
                              },
                              {
                                 "filter":"datum.magnitude_body > 0"
                              },
                              {
                                 "filter":"datum.magnitude_surface > 0"
                              },
                              {
                                 "filter":{
                                    "param":"type_select"
                                 }
                              },
                              {
                                 "filter":{
                                    "param":"region_select"
                                 }
                              }
                           ],
                           "mark":{
                              "type":"point",
                              "filled":true
                           },
                           "encoding":{
                              "x":{
                                 "field":"magnitude_body",
                                 "type":"quantitative",
                                 "scale":{
                                    "domain":[
                                       3,
                                       9
                                    ]
                                 }
                              },
                              "y":{
                                 "field":"magnitude_surface",
                                 "type":"quantitative",
                                 "scale":{
                                    "domain":[
                                       2.5,
                                       6.5
                                    ]
                                 }
                              },
                              "color":{
                                 "field":"country"
                              },
                              "opacity":{
                                 "condition":{
                                    "param":"country_select",
                                    "value":1
                                 },
                                 "value":0
                              }
                           }
                        },
                        {
                           "mark":{
                              "type":"line",
                              "color":"firebrick"
                           },
                           "transform":[
                              {
                                 "filter":{
                                    "param":"year_brush"
                                 }
                              },
                              {
                                 "filter":"datum.magnitude_body > 0"
                              },
                              {
                                 "filter":"datum.magnitude_surface > 0"
                              },
                              {
                                 "regression":"magnitude_body",
                                 "on":"magnitude_surface"
                              }
                           ],
                           "encoding":{
                              "x":{
                                 "field":"magnitude_body",
                                 "type":"quantitative"
                              },
                              "y":{
                                 "field":"magnitude_surface",
                                 "type":"quantitative"
                              }
                           }
                        }
                     ]
                  }
               ]
            }
         ]
      },
      {
         "params":[
            {
               "name":"year_brush",
               "select":{
                  "type":"interval",
                  "encodings":[
                     "x"
                  ]
               }
            }
         ],
         "transform":[
            {
               "filter":{
                  "param":"country_select"
               }
            },
            {
               "filter":{
                  "param":"type_select"
               }
            },
            {
               "filter":{
                  "param":"region_select"
               }
            }
         ],
         "mark":"bar",
         "width":915,
         "height":150,
         "encoding":{
            "x":{
               "field":"year",
               "type":"nominal",
               "timeUnit":"year"
            },
            "y":{
               "aggregate":"count",
               "type":"quantitative"
            },
            "color":{
               "condition":{
                  "param":"year_brush",
                  "field":"country"
               },
               "value":"gray"
            }
         }
      }
   ]
}